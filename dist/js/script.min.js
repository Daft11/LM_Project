window.onload=()=>{const e=document.getElementById("filter_btn");document.getElementById("slideBar");choiceBox.linkButton(),e.addEventListener("click",filterObj.openFilters)};class Filter{itemsArray;constructor(){fetch("/getItemsArray").then(e=>e.json()).then(e=>{this.itemsArray=e,this.setOfChecked()}).catch(e=>console.warn(e))}setOfChecked=()=>{filterObj.getMaterialsIds().forEach((e,t)=>{(e=document.getElementById(e)).addEventListener("click",(function(e){let i=filterObj.getSortCovers();!0===e.target.checked?i[t].forEach(e=>document.getElementById(e).checked=!0):i[t].forEach(e=>document.getElementById(e).checked=!1)}))})};getMaterialsIds=()=>{const e=[];return this.itemsArray.forEach(t=>{e.includes(t.idMaterial)||e.push(t.idMaterial)}),e};getCoversIds=()=>{const e=[];return this.itemsArray.forEach(t=>{e.includes(t.idCover)||e.push(t.idCover)}),e};getSortCovers=()=>{const e=this.getMaterialsIds(),t=[];return e.forEach(e=>{const i=[];this.itemsArray.forEach(t=>{t.idMaterial===e&&(i.includes(t.idCover)||i.push(t.idCover))}),t.push(i)}),t};openFilters=()=>{document.getElementById("filter_submit-btn").addEventListener("click",this.submitFilters),document.getElementById("filter_clear-btn").addEventListener("click",this.clearFilters),document.addEventListener("click",e=>{document.getElementById("facade__filter").contains(e.target)||this.sidebarHide()}),"510px"==slideBar.style.height?this.sidebarHide():this.sidebarShow()};submitFilters=()=>{const e=this.getMaterialsIds(),t=this.getCoversIds();this.reloadFilter(),this.filterCheckLoop(e),this.filterCheckLoop(t),this.sidebarHide(),this.showResult()};reloadFilter=()=>{this.itemsArray.forEach(e=>document.getElementById(e.idFacade).style.display="flex")};sidebarHide=()=>{slideBar.style.height="50px",filter_btn.className="filter__btn"};sidebarShow=()=>{slideBar.style.height="510px",filter_btn.className+="_after"};clearFilters=()=>{this.itemsArray.forEach(e=>{document.getElementById(e.idMaterial).checked=!1,document.getElementById(e.idCover).checked=!1}),this.submitFilters()};filterCheckLoop=e=>{let t,i=[];if(e.forEach(e=>{t=document.getElementById(e),!0===t.checked&&i.push(e)}),i.length>0)return i=e.filter(e=>i.includes(e)),this.filterAction(i)};filterAction=e=>{const t=[];this.itemsArray.filter(t=>!e.includes(t.idMaterial)&&!e.includes(t.idCover)).forEach(e=>t.push(e.idFacade));for(var i=0;i<t.length;i++)document.getElementById(t[i]).style.display="none";return t};showResult=()=>{const e=document.getElementById("filter_info"),t=this.getMaterialsIds(),i=this.getCoversIds();let s=[];s=s.concat(this.filterCheckLoop(t)).concat(this.filterCheckLoop(i)),s=s.reduce((e,t)=>e.includes(t)||null==t?e:[...e,t],[]),s.length>0?(e.innerHTML="Показано "+(this.itemsArray.length-s.length)+" из "+this.itemsArray.length+'<a class="filter__info__clear-btn" id="filter__info__clear-btn"></a>',document.getElementById("filter__info__clear-btn").addEventListener("click",this.clearFilters)):e.innerHTML=""}}const filterObj=new Filter,choiceBox={facadeId:null,areaButton:document.getElementById("next__btn"),linkButton(){this.areaButton.addEventListener("click",shapeBox.startBox.bind(shapeBox));const e=document.getElementsByClassName("item__choice-button");for(let t of e)t.addEventListener("click",this.action.bind(choiceBox))},action(e){setBoxHeight("submit__facade","100px");const t=document.getElementById("selected__facade__name"),i=document.getElementById("selected__facade__img");t.innerHTML=e.target.parentElement.getElementsByClassName("item__name")[0].innerHTML,i.src=e.target.parentElement.getElementsByClassName("item__img")[0].src,this.facadeId=e.target.parentElement.id}},shapeBox={shape:"line",sizeArray:[],shapeCardsIdArray:["geometry-line-shaped","geometry-l-shaped-left","geometry-l-shaped-right","geometry-u-shaped"],sizeInputIdArray:["size-first","size-second","size-third"],sizeWall:document.getElementById("size-wall"),sizeWallDefaultClassName:"enter__size-wall",inputVisibilitySet:{line:[1,.2,.2,!1,!0,!0],lShapedLeft:[1,1,.2,!1,!1,!0],lShapedRight:[1,1,.2,!1,!1,!0],uShaped:[1,1,1,!1,!1,!1]},animDependency:{first:"anim-left-border",second:"anim-top-border",third:"anim-right-border"},inputValidSumArray:{first:{validity:!1,enabled:!1},second:{validity:!1,enabled:!1},third:{validity:!1,enabled:!1}},startBox(){setBoxHeight("shape-box","100vh","600px"),document.getElementById("shape-box").style.overflow="visible",this.switchShape(),this.getShape(),this.flashingWall(),document.getElementById("calc__btn").addEventListener("click",summaryProgress.startSummary.bind(summaryProgress))},inputFocus(){const e=document.getElementById(this.sizeInputIdArray[0]).firstElementChild;e.focus(),e.select()},switchShape(){this.shapeCardsIdArray.forEach(e=>{document.getElementById(e).addEventListener("change",shapeBox.getShape.bind(shapeBox))})},getShape(){this.shapeCardsIdArray.forEach(e=>{document.getElementById(e).checked&&(this.shape=document.getElementById(e).value,this.sizeWall.className=this.sizeWallDefaultClassName,this.sizeWall.className+=e.slice(8),this.inputShowSwitch(this.shape),setBoxHeight("submit-size","0px"),this.formValidCheck())})},inputShowSwitch(e){const t=e.split("-").reduce((e,t,i)=>i>0?e+t.charAt(0).toUpperCase()+t.slice(1):e+t,"");this.inputValidSumArray.first.enabled=!this.inputVisibilitySet[t][3],this.inputValidSumArray.second.enabled=!this.inputVisibilitySet[t][4],this.inputValidSumArray.third.enabled=!this.inputVisibilitySet[t][5];for(var i=0;i<this.sizeInputIdArray.length;i++)document.getElementById(this.sizeInputIdArray[i]).style.opacity=this.inputVisibilitySet[t][i],document.getElementById(this.sizeInputIdArray[i]).firstElementChild.disabled=this.inputVisibilitySet[t][i+3];return this.inputFocus()},flashingWall(){for(var e=0;e<this.sizeInputIdArray.length;e++)document.getElementById(this.sizeInputIdArray[e]).firstElementChild.addEventListener("focus",shapeBox.animCurrentWall),document.getElementById(this.sizeInputIdArray[e]).firstElementChild.addEventListener("blur",shapeBox.animCurrentWallDisable),document.getElementById(this.sizeInputIdArray[e]).firstElementChild.addEventListener("input",shapeBox.inputValidCheck)},animCurrentWall(e){const t=e.target.name,i=shapeBox.animDependency[t];shapeBox.sizeWall.classList.add(i)},animCurrentWallDisable(e){const t=e.target.name,i=shapeBox.animDependency[t];shapeBox.sizeWall.classList.remove(i)},inputValidCheck(e){const t=e.target.name;0==+e.target.value?e.target.setCustomValidity("Invalid field."):e.target.setCustomValidity(""),shapeBox.inputValidSumArray[t].validity=e.target.validity.valid,shapeBox.formValidCheck()},formValidCheck(){const e=[];let t=!0;for(const[t,i]of Object.entries(this.inputValidSumArray))i.enabled&&e.push(t);for(var i=0;i<e.length;i++)t=t&&shapeBox.inputValidSumArray[e[i]].validity;t?(setBoxHeight("baner-help","0"),setBoxHeight("submit-size","100px","80px"),document.getElementById("shape-box").scrollIntoView(!1),this.pushSize(e)):(setBoxHeight("baner-help","100px"),setBoxHeight("submit-size","0px","0"),summaryProgress.hideSummary())},pushSize(e){this.sizeArray=[];for(var t=0;t<e.length;t++)this.sizeArray.push(Number(document.getElementById(this.sizeInputIdArray[t]).firstElementChild.value))}};let framesInfo=fetch("/getFramesInfo").then(e=>e.json()).then(e=>{framesInfo=e});const summaryProgress={areaId:"calculating__area",facade:"",shape:"",size:[],resFrameSizeArrayTop:[],resFramePriceArrayTop:[],resFrameSizeArrayBottom:[],resFramePriceArrayBottom:[],startSummary(){this.pullParams(),setBoxHeight(this.areaId,"300px")},hideSummary(){setBoxHeight(this.areaId,"0")},pullParams(){this.facade=Object.assign("",shapeBox.facadeId),this.shape=Object.assign("",shapeBox.shape),this.size=Object.assign([],shapeBox.sizeArray),this.resFrameSizeArrayBottom=[],this.resFramePriceArrayBottom=[],this.CalcFramesBottom=new CalcFrames(this.size,"bottom")},consShowFiltredBuilds(e){this.calcPrice(e)},calcPrice(e){e.forEach((e,t)=>{let i=[];e.forEach(e=>{let t=e.reduce((e,t)=>{const i=framesInfo.position.botttom.sizes.indexOf(t);return e+=framesInfo.position.botttom.prices[i]},0);i.push(t)}),i=i.reduce((e,t)=>e+t),this.resFramePriceArrayBottom.push(i)}),this.pickCheapest(e,this.resFramePriceArrayBottom),console.log(this.resFrameSizeArrayBottom,this.resFramePriceArrayBottom)},pickCheapest(e,t){let i=0;this.resFramePriceArrayBottom.reduce((e,t,s)=>t<e?(i=s,t):e,1/0);this.resFrameSizeArrayBottom=e[i],this.resFramePriceArrayBottom=t[i]}};class CalcFrames{constructor(e,t){"bottom"===t?(this.resFramePriceArrayBottom=[],this.resFrameSizeArrayBottom=[],this.bigFrames=framesInfo.position.botttom.sizes.slice(6),this.calculateSizes(e)):"top"===t&&(this.resFramePriceArrayTop=[],this.resFrameSizeArrayTop=[],this.calculateSizes(e))}calculateSizes=e=>{this.size=e,this.size.forEach((e,t)=>promRed(this.fixkWallSize(e),framesInfo.position.botttom.sizes).then(e=>this.pusher(e,this.resFrameSizeArrayBottom)))};fixkWallSize(e){return e>=1100&&e<1200?1050:e-e%50}pusher=(e,t)=>{t.push(e),t.length==this.size.length&&this.bigSizeReducer(t,t.length)};bigSizeReducer(e){e.forEach((t,i)=>{let s=t.filter(e=>!this.bigFrames.includes(e[e.length-3]));3==e.length?s=s.filter(e=>e.includes(600)||!this.isArrayInclBigSizeAt(e,e.length-3)):2==e.length?s=s.filter(e=>e.includes(600)||!this.isArrayInclBigSizeAt(e,e.length-2)):1==e.length&&(s=s.filter(e=>!this.isArrayInclBigSizeAt(e,e.length-1))),e[i]=s}),this.pickCalculator(e)}pickCalculator(e){1===e.length?this.filterBuildsOne(e):2===e.length?this.filterBuildsTwo(e):3===e.length&&this.filterBuildsThree(e)}filterBuildsOne(e){let t=[],i=[];e[0].forEach((e,t)=>{let s=e.filter(t=>e.includes(600));s.length>0&&i.push(s)}),t[0]=i,summaryProgress.consShowFiltredBuilds(t)}filterBuildsTwo(e){framesInfo.position.botttom.prices[framesInfo.position.botttom.sizes.indexOf(600)];let t=[],i=0;e[0].forEach((s,r)=>{this.isArrayInclBigSizeAt(s,s.length-2)||e[1].forEach((e,r)=>{this.isArrayInclBigSizeAt(e,e.length-2)||(t[i]=[],t[i].push(s),t[i].push(e),i++)})});let s=[],r=[];t.forEach(e=>{s=e[0].concat(e[1]),!this.isArrayInclBigSizeAt(e[0],e[0].length-1)&&e[0].includes(600)&&this.isArrayInclBigSizeAt(e[1],e[1].length-1)&&this.checkForNumberOfFrames(s,600,2)&&r.push(e)}),t.forEach(e=>{s=e[0].concat(e[1]),this.isArrayInclBigSizeAt(e[0],e[0].length-1)&&e[1].includes(600)&&!this.isArrayInclBigSizeAt(e[1],e[1].length-1)&&this.checkForNumberOfFrames(s,600,2)&&r.push(e)}),r=this.fixExcessFrames(r,2),summaryProgress.consShowFiltredBuilds(r)}filterBuildsThree(e,t){const i=framesInfo.position.botttom.sizes.slice(6);framesInfo.position.botttom.prices[framesInfo.position.botttom.sizes.indexOf(600)];let s=[],r=0;e[0].forEach((t,a)=>{i.includes(t[t.length-2])||e[1].forEach((a,n)=>{e[2].forEach((e,n)=>{i.includes(e[e.length-2])||(s[r]=[],s[r].push(t),s[r].push(a),s[r].push(e),r++)})})});let a=[],n=[];s.forEach(e=>{a=e[0].concat(e[1]).concat(e[2]),i.includes(e[0][e[0].length-1])&&this.checkForNumberOfFrames(e[1],600,2)&&!i.includes(e[1][e[1].length-1])&&i.includes(e[2][e[2].length-1])&&this.checkForNumberOfFrames(a,600,3)&&n.push(e)}),s.forEach(e=>{a=e[0].concat(e[1]).concat(e[2]),i.includes(e[0][e[0].length-1])&&this.checkForNumberOfFrames(e[1],600,1)&&i.includes(e[1][e[1].length-1])&&this.checkForNumberOfFrames(e[2],600,1)&&!i.includes(e[2][e[2].length-1])&&this.checkForNumberOfFrames(a,600,3)&&n.push(e)}),s.forEach(e=>{a=e[0].concat(e[1]).concat(e[2]),!i.includes(e[0][e[0].length-1])&&this.checkForNumberOfFrames(e[0],600,1)&&i.includes(e[1][e[1].length-1])&&this.checkForNumberOfFrames(e[1],600,1)&&i.includes(e[2][e[2].length-1])&&this.checkForNumberOfFrames(a,600,3)&&n.push(e)}),s.forEach(e=>{a=e[0].concat(e[1]).concat(e[2]),!i.includes(e[0][e[0].length-1])&&this.checkForNumberOfFrames(e[0],600,1)&&i.includes(e[1][e[1].length-2])&&this.checkForNumberOfFrames(e[2],600,1)&&!i.includes(e[2][e[2].length-1])&&this.checkForNumberOfFrames(a,600,3)&&n.push(e)}),n=this.fixExcessFrames(n,3),summaryProgress.consShowFiltredBuilds(n)}fixExcessFrames(e,t){return 2===t?e=e.map(e=>e=e.map(e=>this.isArrayInclBigSizeAt(e,e.length-1)?e:this.removeFrame(e,600,1))):3===t&&(e=e.map(e=>e=e.map((e,t)=>0!=t&&2!=t||this.isArrayInclBigSizeAt(e,e.length-1)?1==t?this.isArrayInclBigSizeAt(e,e.length-1)?!this.isArrayInclBigSizeAt(e,e.length-2)&&this.isArrayInclBigSizeAt(e,e.length-1)?this.removeFrame(e,600,1):e:this.removeFrame(e,600,2):e:this.removeFrame(e,600,1)))),e}removeFrame(e,t,i){let s=e.reduce((e,i)=>i==t?e+1:e,0);e=e.filter(e=>e!=t);for(var r=0;r<s-i;r++)e.push(t);return e}isArrayInclBigSizeAt(e,t){return this.bigFrames.includes(e[t])}checkForNumberOfFrames(e,t,i){return e.reduce((e,i)=>i==t?e+1:e,0)>=i}}function setBoxHeight(e,t,i){const s=document.getElementById(e);document.getElementById(e).style.height!=t&&(s.style.height=t),i&&(s.style.minHeight=i)}function onlyNumberKey(e){var t=e.which?e.which:e.keyCode;return!(t>31&&(t<48||t>57))}function checkLength(e,t){if(t.value.length<=e)return!0;var i=t.value;i=i.substring(0,i.length-1),t.value=i}const promRed=(e,t)=>{var i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({length:e,sizes:t})};return fetch("/permutation",i).then(e=>e.json()).then(e=>new Promise((t,i)=>{e.forEach(e=>{e.sort((e,t)=>e-t)}),t(e)})).then(e=>Array.from(new Set(e.map(JSON.stringify)),JSON.parse)).catch(e=>console.log("error",e))};